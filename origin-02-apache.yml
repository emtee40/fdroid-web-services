---
- name: "setup apache2 to serve a static website"
  hosts:
    - origin

  tasks:

    - name: "assert running on debian"
      assert:
        that: "{{ item }}"
      with_items:
        - ansible_distribution == 'Debian'
        - ansible_distribution_release == 'bookworm'

    - name: "apt: install apache2"
      apt:
        install_recommends: no
        update_cache: yes
        name:
          - apache2
        state: present
        cache_valid_time: 8640000  # ommit cache update when chache has been updated in the last 100 days

    - name: "file: enable apache modules"
      file:
        src: "../mods-available/{{ item }}"
        dest: "/etc/apache2/mods-enabled/{{ item }}"
        owner: root
        group: root
        state: link
      notify: restart_apache2
      with_items:
        - cache.load
        - cache_disk.conf
        - cache_disk.load
        - headers.load
        - include.load
        - md.load
        - proxy.conf
        - proxy.load
        - proxy_http.load
        - rewrite.load
        - ssl.load
        - socache_shmcb.load

    - name: "file: disable apache modules"
      file:
        path: "../mods-enabled/{{ item }}"
        state: absent
      notify: restart_apache2
      with_items:
        # not sure why we want this disabled, but let's mimic the legacy setup for now
        - autoindex.conf
        - autoindex.load

    - name: "file: disable default apache site config"
      file:
        path: /etc/apache2/sites-enabled/000-default.conf
        state: absent
      notify: reload_apache2

    - name: "copy: deploy apache site config"
      template:
        src: site-fdroid-origin.conf.j2
        dest: /etc/apache2/sites-available/fdroid-origin.conf
        owner: root
        group: root
        mode: 0644
      notify: reload_apache2

    - name: "file: enable apache config fdroid"
      file:
        src: /etc/apache2/sites-available/fdroid-origin.conf
        dest: /etc/apache2/sites-enabled/fdroid-origin.conf
        owner: root
        group: root
        state: link
      notify: reload_apache2

  handlers:
  - name: restart_apache2
    systemd:
      name: apache2.service
      state: restarted
  - name: reload_apache2
    systemd:
      name: apache2.service
      state: reloaded
